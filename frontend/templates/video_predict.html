{% extends "layout.html" %}
{% block content %}
<div class="max-w-2xl mx-auto bg-white p-6 rounded-xl shadow-md">
  <h2 class="text-2xl font-bold text-center text-blue-600 mb-4">Video Prediction</h2>

  <form id="uploadForm" method="POST" enctype="multipart/form-data" class="space-y-4">
    <label class="block text-gray-700 font-semibold">Upload Endoscopic Video:</label>
    <input type="file" name="video" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-400">

    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">
      Submit Video
    </button>

    <!-- Loading Bar -->
    <div id="loadingBox" class="mt-6 hidden">
      <div class="text-center text-sm font-semibold text-gray-600 mb-2">Processing video, please wait...</div>
      <div class="w-full bg-gray-200 rounded-full h-3">
        <div class="bg-blue-500 h-3 rounded-full animate-pulse" style="width: 100%"></div>
      </div>
    </div>
  </form>

  <!-- FINAL PREDICTION -->
{% if show_result %}
  {% if error %}
    <div class="mt-6 bg-red-100 text-red-700 p-4 rounded border border-red-400">
      <p><strong>Error:</strong> {{ error }}</p>
    </div>
  {% else %}
    <div class="mt-6">
      <h3 class="text-xl font-bold text-center text-green-700 mb-4">
        Final Prediction: <span class="text-black">{{ final_label }}</span>
      </h3>

      <div class="mb-4">
        <h4 class="text-md font-semibold text-gray-700 mb-1">Uploaded Video:</h4>
        <video width="100%" height="auto" controls class="rounded-lg shadow">
          <source src="{{ url_for('uploaded_file', filename='images/' ~ video_filename) }}" type="video/mp4">
          Your browser does not support the video tag.
        </video>
      </div>

      <!-- TOGGLE FRAME TABLE -->
      <div class="text-center">
        <button onclick="toggleTable()" id="toggleButton"
          class="bg-gray-100 hover:bg-gray-200 border border-gray-300 text-gray-800 font-medium py-2 px-4 rounded">
          Show Frame-by-Frame Predictions
        </button>
      </div>

      <!-- FRAME TABLE (hidden by default) -->
      <div id="frameTable" class="mt-4 hidden">
        <h4 class="text-lg font-semibold text-gray-700 mb-2">Frame-wise Predictions:</h4>
        <div class="overflow-x-auto">
          <p class="text-sm text-gray-500 mb-2">
            <span class="inline-block w-4 h-4 bg-red-100 border border-red-300 align-middle mr-2"></span>
            <span class="align-middle">Highlighted rows indicate suspicious (cancerous) frames.</span>
          </p>
          <table class="table-auto w-full border">
            <thead>
              <tr class="bg-gray-100">
                <th class="border px-4 py-2">Frame</th>
                <th class="border px-4 py-2">Label</th>
                <th class="border px-4 py-2">Confidence</th>
              </tr>
            </thead>
            <tbody>
              {% for p in predictions %}
              <tr class="cursor-pointer {% if p.label == 'Cancerous' %}bg-red-100 text-red-800 font-semibold{% endif %}"
                  data-frame="{{ p.frame }}">
                <td class="border px-4 py-2">{{ p.frame }}</td>
                <td class="border px-4 py-2">{{ p.label }}</td>
                <td class="border px-4 py-2">{{ "%.3f"|format(p.confidence) }}</td>
              </tr>
              {% endfor %}
            </tbody>

          </table>
        </div>
      </div>
    </div>
  {% endif %}
{% endif %}

</div>

<script>
  const form = document.getElementById("uploadForm");
  const loadingBox = document.getElementById("loadingBox");

  form.addEventListener("submit", () => {
    loadingBox.classList.remove("hidden");
  });
</script>
<script>
  const toggleTable = () => {
    const table = document.getElementById("frameTable");
    const button = document.getElementById("toggleButton");
    table.classList.toggle("hidden");
    if (!table.classList.contains("hidden")) {
      button.textContent = "Hide Frame-by-Frame Predictions";
    } else {
      button.textContent = "Show Frame-by-Frame Predictions";
    }
  };
</script>
<script>
  const frameRate = 30; // Adjust if your frame skip or FPS differs
  const videoPlayer = document.querySelector("video");

  document.querySelectorAll("#frameTable tbody tr").forEach(row => {
    row.addEventListener("click", () => {
      const frame = parseInt(row.dataset.frame);
      const time = frame / frameRate;
      videoPlayer.currentTime = time;
      videoPlayer.pause();

      row.classList.add("ring-2", "ring-blue-400");
      setTimeout(() => {
        row.classList.remove("ring-2", "ring-blue-400");
      }, 500);
    });
  });
  
</script>

{% endblock %}
